<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"
	  xmlns:f="http://typo3.org/ns/fluid/ViewHelpers"
	  xmlns:gallery="http://typo3.org/ns/Fab/NaturalGallery/ViewHelpers"
	  xmlns:v="http://typo3.org/ns/FluidTYPO3/Vhs/ViewHelpers">

	<f:layout name="Default"/>

	<f:section name="main">

		<f:if condition="{gallery:isIconsPartialAlreadyLoaded()}">
			<f:render section="Icons" partial="Icons"/>
		</f:if>

		<f:if condition="'{settings.lightbox}' == true">
			<f:if condition="{gallery:isPhotoswipePartialAlreadyLoaded()}">
				<v:page.footer content="{f:render(section: 'Photoswipe', partial: 'Photoswipe')}"></v:page.footer>
			</f:if>
		</f:if>

		<div id="gallery-{v:content.info(field:'uid')}"></div>

	<script>
		// Wait for DOM to be ready and Natural Gallery v10 to be loaded
		document.addEventListener('DOMContentLoaded', function() {
			// Check if Natural Gallery v10 is available
			if (typeof window.Natural === 'undefined') {
				console.error('Natural Gallery v10 not found. Make sure natural-gallery.full.js is loaded.');
				return;
			}

			// Gallery element
			const galleryElement = document.getElementById('gallery-<v:content.info field="uid"></v:content.info>');
			
			if (!galleryElement) {
				console.error('Gallery element not found');
				return;
			}
			
			// Convert TYPO3 settings to v10 options format
			const options = {
				// Map old setting names to new v10 API
				gap: Number('{settings.margin}') || 3,
				rowHeight: Number('{settings.rowHeight}') || 350,
				format: '{settings.thumbnailFormat}',
				round: Number('{settings.round}') || 0,
				imagesPerRow: Number('{settings.imagesPerRow}') || 0,
				limit: Number('{settings.limit}') || 0,
				showLabels: '{settings.showLabels}' || 'hover',
				lightbox: '{settings.lightbox}' === '1' || '{settings.lightbox}' === 'true',
				showCount: '{settings.showCount}' === '1' || '{settings.showCount}' === 'true',
				searchFilter: '{settings.searchFilter}' === '1' || '{settings.searchFilter}' === 'true',
				categoriesFilter: '{settings.categoriesFilter}' === '1' || '{settings.categoriesFilter}' === 'true',
				showNone: '{settings.showNone}' === '1' || '{settings.showNone}' === 'true',
				showOthers: '{settings.showOthers}' === '1' || '{settings.showOthers}' === 'true',
				
				// PhotoSwipe v5 options for v10
				photoSwipeOptions: {
					loop: '{settings.lightbox}' === '1' || '{settings.lightbox}' === 'true'
				},
				
				// Labels for v10
				labelCategories: '<f:translate key="labelCategories" />',
				labelNone: '<f:translate key="labelNone" />',
				labelOthers: '<f:translate key="labelOthers" />',
				labelSearch: '<f:translate key="labelSearch" />',
				labelImages: '<f:translate key="labelImages" />'
			};

			// Get image data in v10 format
			//@off
			const imagesData = {gallery:imageStack()->f:format.raw()};
			//@on
			
			// Initialize Natural Gallery v10
			try {
				const gallery = new window.Natural(galleryElement, options);
				
				// Add images if available
				if (imagesData && imagesData.length > 0) {
					gallery.addItems(imagesData);
				}
				
				// Store gallery instance for potential external access
				window.naturalGalleryInstance = gallery;
				
				console.log('Natural Gallery v10 initialized successfully');
				
			} catch (error) {
				console.error('Failed to initialize Natural Gallery v10:', error);
			}
		});
	</script>

		<gallery:loadAssets/>

	</f:section>

</html>
